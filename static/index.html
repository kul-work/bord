<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bord</title>
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <span id="welcomeDisplay" class="username-display">Welcome on </span>
            <a href="/"><h1><img src="B.png" alt="Bord" style="width: 2em; vertical-align: middle; margin-right: 2px;">ord</h1></a><span id="usernameDisplay" class="username-display"></span>
        </div>
        
        <div id="error" class="error"></div>
        <div id="success" class="success"></div>

        <!-- Login/Register Form -->
        <div id="authSection" class="auth-form">
            <h2 style="margin-bottom: 20px; font-size: 20px;">Log In or Sign Up</h2>
            <input type="text" id="username" placeholder="Username" autocomplete="username" onkeypress="if(event.key==='Enter'){login()}">
            <input type="password" id="password" placeholder="Password" autocomplete="password" onkeypress="if(event.key==='Enter'){login()}">
            <button onclick="login()" style="background: #6c757d; margin-top: 10px;">Log In</button>
            <button onclick="register()">Sign Up</button>            
        </div>

        <!-- Navigation -->
        <div id="postSection" class="post-form hidden">
            <center>
                <button class="nav-btn active" onclick="showFeed()">Feed</button>
                <button class="nav-btn" onclick="showFollowers()">Followers</button>
                <button class="nav-btn" onclick="showFollowing()">Following</button>
                <button class="nav-btn" onclick="showProfile()">Profile</button>
                <button class="logout" onclick="logout()">Log Out</button>
            </center>
        </div>

        <!-- New Post Form -->
        <div id="newPostSection" class="post-form hidden">
            <h2 style="margin-bottom: 20px; font-size: 20px;">New Post</h2>
            <textarea id="postContent" placeholder="What's on your mind?"></textarea>
            <button onclick="createPost()">Post</button>
        </div>

        <!-- Posts Feed -->
        <div id="feedSection" class="posts hidden">
            <h2 id="feedTitle" style="margin-bottom: 20px; font-size: 20px;">Bords</h2>
            <div id="feed"></div>
            <div id="feedPagination" class="pagination" style="margin-top: 20px; text-align: center;"></div>
        </div>

        <!-- Followers/Following Section -->
        <div id="followersSection" class="profile-form hidden">
            <h2 id="followersTitle" style="margin-bottom: 20px; font-size: 20px;">Followers</h2>
            <div id="followersList"></div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="profile-form hidden">
            <h2 style="margin-bottom: 20px; font-size: 20px;">Profile</h2>
            
            <div class="profile-field">
                <div class="profile-field-label">Username</div>
                <div class="profile-field-value" id="profileUsername">-</div>
            </div>

            <div class="form-group">
                <label for="profileBio">BIO</label>
                <textarea id="profileBio" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                <small id="bioChars">0/500</small>
            </div>

            <button onclick="saveBio()" style="background: #28a745;">Save Bio</button>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

            <h3 style="margin: 15px 0; font-size: 16px;">Change Password</h3>
            <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" placeholder="Current password" autocomplete="current-password">
            </div>
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" placeholder="New password" autocomplete="new-password">
            </div>
            <button onclick="changePassword()" style="background: #dc3545;">Change Password</button>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

            <h3 style="margin: 15px 0; font-size: 16px;">My Bords</h3>
            <div id="profilePosts"></div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="edit-modal">
            <div class="edit-modal-content">
                <h3>Edit Post</h3>
                <textarea id="editContent" placeholder="What's on your mind?"></textarea>
                <div class="modal-buttons">
                    <button onclick="cancelEdit()" style="background: #6c757d;">Cancel</button>
                    <button onclick="saveEdit()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        let currentUsername = localStorage.getItem('username');
        let currentUserId = localStorage.getItem('user_id');
        let editingPostId = null;
        let postsMap = {};
        let currentView = 'feed';
        let currentPage = 1;
        let hasMorePosts = true;

        function showError(msg) {
            const err = document.getElementById('error');
            err.textContent = msg;
            err.classList.add('show');
            setTimeout(() => err.classList.remove('show'), 3000);
        }

        function showSuccess(msg) {
            const suc = document.getElementById('success');
            suc.textContent = msg;
            suc.classList.add('show');
            setTimeout(() => suc.classList.remove('show'), 1000);
        }

        function updateNavButtons(active) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.textContent.trim() === active) {
                    btn.classList.add('active');
                }
            });
        }

        function showFeed() {
            currentView = 'feed';
            currentPage = 1;
            document.getElementById('feedSection').classList.remove('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('newPostSection').classList.add('hidden');
            document.getElementById('followersSection').classList.add('hidden');
            updateNavButtons('Feed');
            loadFeed();
        }

        function showProfile() {
            currentView = 'profile';
            currentPage = 1;
            document.getElementById('feedSection').classList.add('hidden');
            document.getElementById('profileSection').classList.remove('hidden');
            document.getElementById('newPostSection').classList.add('hidden');
            document.getElementById('followersSection').classList.add('hidden');
            updateNavButtons('Profile');
            loadProfile();
        }

        function showFollowers() {
            currentView = 'followers';
            document.getElementById('feedSection').classList.add('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('newPostSection').classList.add('hidden');
            document.getElementById('followersSection').classList.remove('hidden');
            document.getElementById('followersTitle').textContent = 'Followers';
            updateNavButtons('Followers');
            loadFollowersList('followers');
        }

        function showFollowing() {
            currentView = 'following';
            document.getElementById('feedSection').classList.add('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('newPostSection').classList.add('hidden');
            document.getElementById('followersSection').classList.remove('hidden');
            document.getElementById('followersTitle').textContent = 'Following';
            updateNavButtons('Following');
            loadFollowersList('following');
        }

        async function loadFollowersList(type) {
            const endpoint = type === 'followers' ? '/followers/' + currentUserId : '/followings/' + currentUserId;
            const res = await apiCall(endpoint, { token });
            
            if (res.ok) {
                const userIds = res.data;
                const section = document.getElementById('followersList');
                
                if (userIds.length === 0) {
                    section.innerHTML = '<p style="color: #999; text-align: center;">No ' + type + ' yet</p>';
                } else {
                    let htmlContent = '';
                    for (const uid of userIds) {
                        const userRes = await apiCall('/users/' + uid);
                        if (userRes.ok) {
                            const user = userRes.data;
                            const bioPreview = user.bio ? user.bio.substring(0, 100) + (user.bio.length > 100 ? '...' : '') : 'No bio';
                            htmlContent += `
                                <div class="user-item">
                                    <div style="flex: 1;">
                                        <a href="/${user.username}" style="font-weight: 600; color: #209CEE; text-decoration: none;">${user.username}</a>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">${bioPreview}</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    section.innerHTML = htmlContent || '<p style="color: #999;">Error loading users</p>';
                }
            } else {
                document.getElementById('followersList').innerHTML = '<p style="color: #999;">Error loading ' + type + '</p>';
            }
        }

        async function register() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showError('Username and password required');
                return;
            }

            const res = await apiCall('/users', {
                method: 'POST',
                body: { username, password }
            });
            
            if (res.status === 201) {
                showSuccess('Account created! Now log in.');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } else if (res.status === 409) {
                showError('Username already exists');
            } else {
                showError('Error creating account');
            }
        }

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showError('Username and password required');
                return;
            }

            const res = await apiCall('/login', {
                method: 'POST',
                body: { username, password }
            });
            
            if (res.ok) {
                const data = res.data;
                token = data.token;
                currentUsername = username;
                currentUserId = data.user_id;
                localStorage.setItem('token', token);
                localStorage.setItem('username', username);
                localStorage.setItem('user_id', currentUserId);
                showUIForLoggedIn();
                loadPosts();
            } else {
                showError('Invalid credentials');
            }
        }

        async function createPost() {
            const content = document.getElementById('postContent').value.trim();
            
            if (!content) {
                showError('Post cannot be empty');
                return;
            }

            const res = await apiCall('/posts', {
                method: 'POST',
                body: { content },
                token
            });
            
            if (res.status === 201) {
                document.getElementById('postContent').value = '';
                showSuccess('Post created!');
                loadPosts();
            } else {
                showError('Error creating post');
            }
        }

        async function deletePost(postId) {
            if (!confirm('Delete this post?')) return;

            const res = await apiCall('/posts/' + postId, {
                method: 'DELETE',
                token
            });
            
            if (res.status === 204) {
                showSuccess('Post deleted!');
                loadPosts();
            } else if (res.status === 403) {
                showError('Cannot delete post');
            } else {
                showError('Error deleting post');
            }
        }

        async function loadPosts(page = 1) {
            document.getElementById('feedTitle').textContent = 'World`s Bord';
            const res = await apiCall(`/posts?all=true&page=${page}`, {});
            
            if (res.ok) {
                const posts = res.data;
                postsMap = {};
                posts.forEach(p => postsMap[p.id] = p);
                
                // Fetch user details for each post
                const postsWithUsers = await Promise.all(posts.map(async (p) => {
                    const userRes = await apiCall('/users/' + p.user_id);
                    if (userRes.ok) {
                        return { ...p, username: userRes.data.username };
                    }
                    return { ...p, username: 'Unknown' };
                }));
                
                currentPage = page;
                hasMorePosts = posts.length === 20;
                renderPosts(postsWithUsers, 'feed', true, true, currentUserId);
                renderPagination();
            } else {
                showError('Failed to load posts');
            }
        }

        async function loadFeed() {
            document.getElementById('feedTitle').textContent = 'Bords on watch';
            const res = await apiCall('/feed', { token });
            
            if (res.ok) {
                const posts = res.data;
                
                // Fetch user details for each post
                const postsWithUsers = await Promise.all(posts.map(async (p) => {
                    const userRes = await apiCall('/users/' + p.user_id);
                    if (userRes.ok) {
                        return { ...p, username: userRes.data.username };
                    }
                    return { ...p, username: 'Unknown' };
                }));
                
                renderPosts(postsWithUsers, 'feed', true, false, currentUserId);
            } else {
                showError('Failed to load feed');
            }
        }

        async function loadProfile(page = 1) {
            const res = await apiCall('/profile', { token });
            
            if (res.ok) {
                const profile = res.data;
                document.getElementById('profileUsername').textContent = profile.username;
                document.getElementById('profileBio').value = profile.bio;
                updateBioCharCount();
            } else {
                showError('Failed to load profile');
            }

            // Load user's posts
            const postsRes = await apiCall(`/posts?page=${page}`, { token });
            
            if (postsRes.ok) {
                const posts = postsRes.data;
                postsMap = {};
                posts.forEach(p => postsMap[p.id] = p);
                currentPage = page;
                hasMorePosts = posts.length === 20;
                renderPosts(posts, 'profilePosts', false, true, currentUserId);
            } else {
                document.getElementById('profilePosts').innerHTML = '<p style="color: #999;">Error loading posts</p>';
            }
        }

        function updateBioCharCount() {
            const bioInput = document.getElementById('profileBio');
            const charCount = bioInput.value.length;
            document.getElementById('bioChars').textContent = charCount + '/500';
        }

        async function saveBio() {
            const bio = document.getElementById('profileBio').value.trim();

            const res = await apiCall('/profile', {
                method: 'PUT',
                body: { bio },
                token
            });

            if (res.ok) {
                showSuccess('Bio updated!');
            } else if (res.status === 400) {
                showError('Bio too long (max 500 chars)');
            } else {
                showError('Error updating bio');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!currentPassword || !newPassword) {
                showError('Please fill in all password fields');
                return;
            }

            if (newPassword.length < 1) {
                showError('New password required');
                return;
            }

            const res = await apiCall('/profile', {
                method: 'PUT',
                body: {
                    old_password: currentPassword,
                    new_password: newPassword
                },
                token
            });

            if (res.ok) {
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                showSuccess('Password changed!');
            } else if (res.status === 401) {
                showError('Current password is incorrect');
            } else if (res.status === 400) {
                showError('Invalid password');
            } else {
                showError('Error changing password');
            }
        }

        function showUIForLoggedIn() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('postSection').classList.remove('hidden');
            document.getElementById('newPostSection').classList.remove('hidden');
            document.getElementById('feedSection').classList.remove('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            const usernameDisplay = document.getElementById('usernameDisplay');
            const welcomeDisplay = document.getElementById('welcomeDisplay');
            usernameDisplay.textContent = ', ' + currentUsername + '!';
            usernameDisplay.classList.add('show');
            welcomeDisplay.classList.add('show');
            currentView = 'feed';
            updateNavButtons('Feed');
        }

        function showUIForLoggedOut() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('postSection').classList.add('hidden');
            document.getElementById('newPostSection').classList.add('hidden');
            document.getElementById('feedSection').classList.add('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            const usernameDisplay = document.getElementById('usernameDisplay');
            const welcomeDisplay = document.getElementById('welcomeDisplay');
            usernameDisplay.classList.remove('show');            
            usernameDisplay.textContent = '';
            welcomeDisplay.classList.remove('show');
        }

        function openEditModal(postId, content) {
            editingPostId = postId;
            document.getElementById('editContent').value = content;
            document.getElementById('editModal').classList.add('show');
        }

        function cancelEdit() {
            editingPostId = null;
            document.getElementById('editContent').value = '';
            document.getElementById('editModal').classList.remove('show');
        }

        async function saveEdit() {
            const content = document.getElementById('editContent').value.trim();

            if (!content) {
                showError('Post cannot be empty');
                return;
            }

            const res = await apiCall('/posts/' + editingPostId, {
                method: 'PUT',
                body: { content },
                token
            });

            if (res.ok) {
                cancelEdit();
                showSuccess('Post updated!');
                loadPosts();
            } else if (res.status === 403) {
                showError('Cannot edit post');
            } else {
                showError('Error updating post');
            }
        }

        async function logout() {
            const res = await apiCall('/logout', {
                method: 'POST',
                token
            });
            
            token = null;
            currentUsername = null;
            currentUserId = null;
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('user_id');
            showUIForLoggedOut();
        }

        function renderPagination() {
            const paginationDiv = document.getElementById('feedPagination');
            let html = '';
            
            const btnStyle = 'padding: 4px 8px; margin-right: 5px; margin-left: 5px; width: 80px; display: inline-block';
            
            if (currentPage > 1) {
                html += `<button onclick="loadPosts(${currentPage - 1})" style="${btnStyle}">← Prev</button>`;
            }
            
            html += `<span style="margin: 0 10px;">Page ${currentPage}</span>`;
            
            if (hasMorePosts) {
                html += `<button onclick="loadPosts(${currentPage + 1})" style="${btnStyle}">Next →</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }

        function stripHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText;
        }

        document.addEventListener('input', function(e) {
            if (e.target.id === 'profileBio') {
                updateBioCharCount();
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-btn')) {
                const postId = e.target.dataset.postId;
                const post = postsMap[postId];
                if (post) {
                    openEditModal(postId, stripHtml(post.content));
                }
            }
        });

        if (token) {
            showUIForLoggedIn();
            loadPosts();
        } else {
            showUIForLoggedOut();
        }
    </script>
</body>
</html>
